# Description: Le kernel avec initrd
# URL:  http://www.kernel.org
# Maintainer: NuTyX core team
# Packager: thierryn1 at hispeed dot ch
# Depends on:

name=kernel-ird
version=2.6.30.4
release=1
_tools=07082009
source=(http://www.kernel.org/pub/linux/kernel/v2.6/linux-${version}.tar.bz2\
	config_64 config)
build(){

rm -rf /usr/src/kernel
mkdir /usr/src/kernel
mv linux-${version} /usr/src/kernel/
ln -svf /usr/src/kernel/linux-${version} 
WDIR=$SRC/installtools
mkdir -p $WDIR
wget http://kiao.no-ip.info/NuTyX/files/installtools-${_tools}.tar.gz
tar -C $WDIR --use-compress-program=gzip -xf installtools-${_tools}.tar.gz
cd linux-$version
make mrproper
case `uname -m` in 
	x86_64)
	mv $SRC/config_64 ./.config;;
	i?86)
	mv $SRC/config ./.config;;
esac
make -j3
make INSTALL_MOD_PATH=$PKG modules_install
mkdir -p $PKG/boot
case `uname -m` in 
	x86_64)
		cp -v System.map \
		$PKG/boot/System_64.map-$version
		cp -v .config    \
		$PKG/boot/config_64-$version
		cp -v arch/x86_64/boot/bzImage \
		$PKG/boot/kernel_64-$version
		ln -sf kernel_64-$version \
		$PKG/boot/kernel_64 ;;
	i?86)
		cp -v System.map \
		$PKG/boot/System.map-$version
		cp -v .config \
		$PKG/boot/config-$version
		cp -v arch/i386/boot/bzImage \
		$PKG/boot/kernel-$version 
		ln -sf kernel-$version \
		$PKG/boot/kernel;;
esac
case `uname -m` in 
	i?86)
	mkdir -p $WDIR/rootfs/lib/modules/$version/kernel/{drivers,fs}
	cp -va $PKG/lib/modules/$version/kernel/crypto \
	$WDIR/rootfs/lib/modules/$version/kernel/
	for i in ata block input ide hid message parport \
	serial misc net pcmcia scsi usb md
	do
		if [ -d $PKG/lib/modules/$version/kernel/drivers/$i ]; then
			cp -va $PKG/lib/modules/$version/kernel/drivers/$i \
			$WDIR/rootfs/lib/modules/$version/kernel/drivers/
		fi
	done
	for i in wireless irda wan bonding \
	hamradio appletalk cxgb3 mlx4 sfc
	do 
		rm -r $WDIR/rootfs/lib/modules/$version/kernel/drivers/net/$i
	done
	for i in fat ntfs smbfs vfat ext4
	do
		if [ -d $PKG/lib/modules/$version/kernel/fs/$i ]; then
			cp -va $PKG/lib/modules/$version/kernel/fs/$i \
			$WDIR/rootfs/lib/modules/$version/kernel/fs/
		fi
	done
	depmod -b $WDIR/rootfs $version

	# Compression des modules
	cd $WDIR/rootfs/lib/modules/$version
	find . -name "*.ko" -exec gzip '{}' \;
	sed -i 's/\.ko/.ko.gz/g' modules.dep
	cd -
	sed -i "s/#version#/$version/" $WDIR/iso/isolinux/boot.msg
	cp -v arch/i386/boot/bzImage $WDIR/iso/isolinux/kernel
	sh $WDIR/script/mkinitrd $WDIR
	cp -v $WDIR/iso/isolinux/initrd $PKG/boot/nutyx-initrd ;;
esac
}
